<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>库存记录小程序</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    input, button { padding: 6px; margin: 2px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #eee; }
    .btn { cursor: pointer; }
  </style>
</head>
<body>

<h1>库存记录</h1>

<input type="text" id="search" placeholder="搜索产品代号或名称..." style="width: 60%;">

<button id="exportCSV" class="btn">导出 CSV</button>
<button id="clearAll" class="btn" style="background:#e74c3c;color:white;">清空所有</button>

<table>
  <thead>
    <tr>
      <th>产品代号</th>
      <th>产品名称</th>
      <th>数量 (支持 12*5, 100/4 等)</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="recordTable"></tbody>
</table>

<script>
let products = {};
let quantities = JSON.parse(localStorage.getItem("quantities") || "{}");

// 加载 JSON 产品列表
fetch("products.json")
  .then(res => res.json())
  .then(data => {
    products = data;
    renderTable();
  })
  .catch(err => alert("加载产品列表失败：" + err));

// 渲染表格
function renderTable() {
  const tbody = document.getElementById("recordTable");
  tbody.innerHTML = "";
  const search = document.getElementById("search").value.toLowerCase();

  Object.entries(products).forEach(([id, name]) => {
    if(id.toLowerCase().includes(search) || name.toLowerCase().includes(search)){
      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      tdId.textContent = id;
      tr.appendChild(tdId);

      const tdName = document.createElement("td");
      tdName.textContent = name;
      tr.appendChild(tdName);

      const tdQty = document.createElement("td");
      const input = document.createElement("input");
      input.type = "text";
      input.value = quantities[id] || "";
      input.style.width = "100%";
      input.onchange = () => {
        let val = input.value;
        try {
          if(val.trim() !== "") val = eval(val.replace(/[^-()\d/*+.]/g,""));
        } catch {}
        quantities[id] = val;
        localStorage.setItem("quantities", JSON.stringify(quantities));
        renderTable();
      };
      tdQty.appendChild(input);
      tr.appendChild(tdQty);

      const tdAction = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "删除";
      delBtn.onclick = () => {
        delete quantities[id];
        localStorage.setItem("quantities", JSON.stringify(quantities));
        renderTable();
      };
      tdAction.appendChild(delBtn);
      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  });
}

// 导出 CSV
document.getElementById("exportCSV").onclick = () => {
  const rows = [["产品代号","产品名称","数量"]];
  Object.entries(quantities).forEach(([id, qty]) => {
    if(qty!=="") rows.push([id, products[id], qty]);
  });
  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "inventory.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

// 清空所有
document.getElementById("clearAll").onclick = () => {
  if(confirm("确认清空所有数据吗？")){
    quantities = {};
    localStorage.removeItem("quantities");
    renderTable();
  }
};

document.getElementById("search").oninput = renderTable;
</script>

</body>
</html>
