import React, { useState, useEffect } from "react";
import productsData from "./products.json";

export default function App() {
  const [products, setProducts] = useState({});
  const [search, setSearch] = useState("");
  const [quantities, setQuantities] = useState({});

  useEffect(() => {
    setProducts(productsData);

    const savedSearch = localStorage.getItem("searchQuery");
    if (savedSearch) setSearch(savedSearch);

    const savedQuantities = localStorage.getItem("quantities");
    if (savedQuantities) setQuantities(JSON.parse(savedQuantities));
  }, []);

  const handleSearchChange = (e) => {
    const value = e.target.value;
    setSearch(value);
    localStorage.setItem("searchQuery", value);
  };

  const handleQuantityChange = (id, value) => {
    let result = value;
    try {
      if (value.trim() !== "") {
        result = eval(value.replace(/[^-()\d/*+.]/g, ""));
      }
    } catch {
      result = value;
    }
    const updated = { ...quantities, [id]: result };
    setQuantities(updated);
    localStorage.setItem("quantities", JSON.stringify(updated));
  };

  const filteredProducts = Object.entries(products).filter(
    ([id, name]) =>
      id.toLowerCase().includes(search.toLowerCase()) ||
      name.toLowerCase().includes(search.toLowerCase())
  );

  const exportCSV = () => {
    const rows = [["产品代号", "产品名称", "数量"]];
    Object.entries(quantities).forEach(([id, qty]) => {
      if (qty !== "") rows.push([id, products[id], qty]);
    });
    const csvContent =
      "data:text/csv;charset=utf-8," +
      rows.map((e) => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "inventory.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const clearAll = () => {
    if (confirm("确认清空所有数据吗？")) {
      setQuantities({});
      localStorage.removeItem("quantities");
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-xl font-bold mb-4">库存记录</h1>

      <input
        type="text"
        value={search}
        onChange={handleSearchChange}
        placeholder="搜索产品 ID 或名称..."
        className="border p-2 rounded w-full mb-4"
      />

      <div className="mb-4 space-x-2">
        <button onClick={exportCSV} className="bg-green-500 text-white p-2 rounded">
          导出 CSV
        </button>
        <button onClick={clearAll} className="bg-red-500 text-white p-2 rounded">
          清空所有
        </button>
      </div>

      <table className="w-full border-collapse border">
        <thead>
          <tr className="bg-gray-100">
            <th className="border p-2 text-left">产品代号</th>
            <th className="border p-2 text-left">产品名称</th>
            <th className="border p-2 text-left">数量 (支持 12*5, 100/4 等)</th>
          </tr>
        </thead>
        <tbody>
          {filteredProducts.length > 0 ? (
            filteredProducts.map(([id, name]) => (
              <tr key={id}>
                <td className="border p-2 font-mono">{id}</td>
                <td className="border p-2">{name}</td>
                <td className="border p-2">
                  <input
                    type="text"
                    value={quantities[id] || ""}
                    onChange={(e) => handleQuantityChange(id, e.target.value)}
                    className="border p-1 rounded w-full"
                    placeholder="输入数量或公式"
                  />
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colSpan="3" className="text-gray-500 p-2">
                没有找到相关产品
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  );
}
