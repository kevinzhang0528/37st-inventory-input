<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inventory Count 37th St</title>
<style>
  /* —— Compact, smaller inputs/buttons; larger table text —— */
  body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:16px; font-size: 14px; }
  .container { max-width: 960px; margin: 0 auto; }

  /* Inputs area */
  .top { display:flex; align-items:flex-start; gap:10px; }
  .left { flex:1; }
  .input-wrapper { position: relative; display: inline-block; width: 70%; }
  input, textarea { width: 70%; padding: 6px 8px; margin: 4px 0; font-size: 14px; height: 34px; }
  #selectedName { width: 100%; height: 34px; font-size: 13px; padding: 6px 8px; margin-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #quantityInput, #noteInput { width: 70%; }

  /* Buttons */
  button { padding: 6px 10px; margin: 4px; font-size: 13px; cursor: pointer; }
  #addRecord { background: orange; color: white; border: none; width: 110px; height: 60px; font-size: 14px; }
  #controls button { font-size: 12px; padding: 6px 8px; }
  .smallButton { font-size:12px; padding: 4px 8px; }

  /* Suggestions dropdown */
  #suggestions { border: 1px solid #ccc; max-height: 180px; overflow-y: auto; background: #fff; position: absolute; z-index: 1000; font-size: 13px; width: 100%; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
  #suggestions div { padding: 6px 8px; cursor: pointer; }
  #suggestions div:hover { background: #eee; }

  /* Table — make text larger for readability */
  table { border-collapse: collapse; width: 100%; margin-top: 14px; font-size: 15px; background:#fff; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; }
  th { background: #f1f1f1; font-weight: 600; }

  .spacer { height: 6px; }
</style>
</head>
<body>
<div class="container">
  <div class="top">
    <div class="left">
      <div class="input-wrapper">
        <input type="text" id="search" placeholder="Enter item code or name..." autocomplete="off" />
        <div id="suggestions"></div>
      </div>
      <input type="text" id="selectedName" placeholder="Selected item" readonly />
      <div>
        <input type="text" id="quantityInput" placeholder="Quantity (supports calculation, e.g. 12*3+5)" />
      </div>
      <div>
        <input type="text" id="noteInput" placeholder="Note (optional)" />
      </div>
    </div>
    <div>
      <button id="addRecord" title="Add to list">Add Record</button>
    </div>
  </div>

  <div id="controls" style="margin-top:6px; display:flex; gap:8px; align-items:center;">
    <button id="exportCSV">Export CSV</button>
    <button id="clearAll" style="background:#e74c3c;color:white; border:none;">Clear All</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Code</th>
        <th>Name</th>
        <th>Qty</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="recordTable"></tbody>
  </table>
</div>

<script>
  let products = {};
  let records = JSON.parse(localStorage.getItem("records") || "[]");

  // Load external product list (expects an object: { "CODE": "Name", ... })
  fetch("products.json")
    .then(res => res.json())
    .then(data => { products = data; renderTable(); })
    .catch(err => alert("Failed to load product list: " + err));

  const searchInput = document.getElementById("search");
  const suggestionsDiv = document.getElementById("suggestions");
  const selectedNameInput = document.getElementById("selectedName");

  // Fuzzy search suggestions
  searchInput.addEventListener("input", () => {
    const val = searchInput.value.toLowerCase();
    suggestionsDiv.innerHTML = "";
    if (val === "") { selectedNameInput.value = ""; return; }
    const matches = Object.entries(products)
      .filter(([id, name]) => id.toLowerCase().includes(val) || String(name).toLowerCase().includes(val))
      .slice(0, 10);
    matches.forEach(([id, name]) => {
      const div = document.createElement("div");
      div.textContent = `${id} - ${name}`;
      div.onclick = () => {
        searchInput.value = id;
        selectedNameInput.value = name;
        suggestionsDiv.innerHTML = "";
      };
      suggestionsDiv.appendChild(div);
    });
  });

  // Render table
  function renderTable() {
    const tbody = document.getElementById("recordTable");
    tbody.innerHTML = "";
    for (let i = records.length - 1; i >= 0; i--) {
      const record = records[i];
      const tr = document.createElement("tr");

      const tdId = document.createElement("td"); tdId.textContent = record.id; tr.appendChild(tdId);
      const tdName = document.createElement("td"); tdName.textContent = record.name; tr.appendChild(tdName);

      const tdQty = document.createElement("td");
      const inputQty = document.createElement("input");
      inputQty.type = "text"; inputQty.value = record.qty; inputQty.className = "smallInput";
      inputQty.style.width = '100%'; inputQty.style.height = '28px'; inputQty.style.fontSize = '14px';
      inputQty.onchange = () => {
        let val = inputQty.value;
        try { if (val.trim() !== "") val = eval(val.replace(/[^-()\d/*+.]/g, "")); } catch {}
        records[i].qty = val;
        localStorage.setItem("records", JSON.stringify(records));
        renderTable();
      };
      tdQty.appendChild(inputQty); tr.appendChild(tdQty);

      const tdNote = document.createElement("td");
      const inputNote = document.createElement("input");
      inputNote.type = "text"; inputNote.value = record.note || ""; inputNote.className = "smallInput";
      inputNote.style.width = '100%'; inputNote.style.height = '28px'; inputNote.style.fontSize = '14px';
      inputNote.onchange = () => {
        records[i].note = inputNote.value;
        localStorage.setItem("records", JSON.stringify(records));
      };
      tdNote.appendChild(inputNote); tr.appendChild(tdNote);

      const tdAction = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete"; delBtn.className = "smallButton";
      delBtn.onclick = () => {
        if (confirm('Are you sure you want to delete this item?')) {
          records.splice(i, 1);
          localStorage.setItem("records", JSON.stringify(records));
          renderTable();
        }
      };
      tdAction.appendChild(delBtn); tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  }

  // Add record
  document.getElementById("addRecord").onclick = () => {
    const searchVal = searchInput.value.trim();
    const qtyVal = document.getElementById("quantityInput").value.trim();
    const noteVal = document.getElementById("noteInput").value.trim();
    if (!searchVal || !qtyVal) { alert("Please fill in product and quantity."); return; }

    let matchedId = null, matchedName = null;
    Object.entries(products).forEach(([id, name]) => {
      if (id.toLowerCase() === searchVal.toLowerCase() || String(name).toLowerCase() === searchVal.toLowerCase()) {
        matchedId = id; matchedName = name;
      }
    });
    if (!matchedId) { alert("No matching product found."); return; }

    let finalQty = qtyVal;
    try { finalQty = eval(qtyVal.replace(/[^-()\d/*+.]/g, "")); } catch {}

    records.push({ id: matchedId, name: matchedName, qty: finalQty, note: noteVal });
    localStorage.setItem("records", JSON.stringify(records));

    searchInput.value = ""; selectedNameInput.value = ""; document.getElementById("quantityInput").value = ""; document.getElementById("noteInput").value = "";
    renderTable();
  };

  // Export CSV
  document.getElementById("exportCSV").onclick = () => {
    const rows = [["code","qty","note"]];
    records.forEach(r => rows.push([r.id, r.qty, r.note || ""]));
    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "inventory.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Clear all
  document.getElementById("clearAll").onclick = () => {
    if (confirm("Clear ALL records?")) {
      records = [];
      localStorage.removeItem("records");
      renderTable();
    }
  };

  renderTable();
</script>
</body>
</html>
