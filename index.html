<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>库存记录小程序</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; font-size: 1.5em; }
  input, button { padding: 12px; margin: 5px; font-size: 1em; }
  button { transform: scale(3); margin: 10px 5px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 1.5em; }
  th, td { border: 1px solid #ccc; padding: 10px; }
  th { background: #eee; }
  #suggestions { border: 1px solid #ccc; max-height: 200px; overflow-y: auto; background: #fff; position: absolute; z-index: 1000; font-size: 1em; }
  #suggestions div { padding: 6px; cursor: pointer; }
  #suggestions div:hover { background: #eee; }
  .input-wrapper { position: relative; display: inline-block; width: 100%; }
  #quantityWrapper { margin-top: 10px; }
</style>
</head>
<body>

<h1>库存记录</h1>

<div class="input-wrapper">
  <input type="text" id="search" placeholder="搜索产品代号或名称..." style="width: 100%;">
  <div id="suggestions"></div>
</div>

<div id="quantityWrapper">
  <input type="text" id="quantityInput" placeholder="数量（支持 12*5, 100/4 等）" style="width: 40%;">
  <button id="addRecord" class="btn">添加记录</button>
</div>

<br><br>
<button id="exportCSV" class="btn">导出 CSV</button>
<button id="clearAll" class="btn" style="background:#e74c3c;color:white;">清空所有</button>

<table>
<thead>
<tr>
<th>产品代号</th>
<th>产品名称</th>
<th>数量</th>
<th>操作</th>
</tr>
</thead>
<tbody id="recordTable"></tbody>
</table>

<script>
let products = {};
let records = JSON.parse(localStorage.getItem("records") || "[]");

// 加载产品 JSON
fetch("products.json")
  .then(res => res.json())
  .then(data => { products = data; renderTable(); })
  .catch(err => alert("加载产品列表失败：" + err));

// 渲染表格
function renderTable() {
  const tbody = document.getElementById("recordTable");
  tbody.innerHTML = "";
  const searchVal = document.getElementById("search").value.toLowerCase();

  records.forEach((record, index) => {
    if(record.id.toLowerCase().includes(searchVal) || record.name.toLowerCase().includes(searchVal)){
      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      tdId.textContent = record.id;
      tr.appendChild(tdId);

      const tdName = document.createElement("td");
      tdName.textContent = record.name;
      tr.appendChild(tdName);

      const tdQty = document.createElement("td");
      const input = document.createElement("input");
      input.type = "text";
      input.value = record.qty;
      input.style.width = "100%";
      input.onchange = () => {
        let val = input.value;
        try { if(val.trim()!=="") val = eval(val.replace(/[^-()\d/*+.]/g,"")); } catch {}
        records[index].qty = val;
        localStorage.setItem("records", JSON.stringify(records));
        renderTable();
      };
      tdQty.appendChild(input);
      tr.appendChild(tdQty);

      const tdAction = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "删除";
      delBtn.onclick = () => {
        records.splice(index,1);
        localStorage.setItem("records", JSON.stringify(records));
        renderTable();
      };
      tdAction.appendChild(delBtn);
      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  });
}

// 模糊搜索建议
const searchInput = document.getElementById("search");
const suggestionsDiv = document.getElementById("suggestions");

searchInput.addEventListener("input", () => {
  const val = searchInput.value.toLowerCase();
  suggestionsDiv.innerHTML = "";
  if(val === "") return;
  const matches = Object.entries(products)
    .filter(([id,name]) => id.toLowerCase().includes(val) || name.toLowerCase().includes(val))
    .slice(0, 10); // 最多10条建议
  matches.forEach(([id,name]) => {
    const div = document.createElement("div");
    div.textContent = `${id} - ${name}`;
    div.onclick = () => {
      searchInput.value = id;
      suggestionsDiv.innerHTML = "";
    };
    suggestionsDiv.appendChild(div);
  });
});

// 点击添加记录
document.getElementById("addRecord").onclick = () => {
  const searchVal = searchInput.value.trim();
  const qtyVal = document.getElementById("quantityInput").value.trim();
  if(!searchVal || !qtyVal){ alert("请填写产品和数量"); return; }

  let matchedId = null;
  let matchedName = null;

  Object.entries(products).forEach(([id,name]) => {
    if(id.toLowerCase() === searchVal.toLowerCase() || name.toLowerCase() === searchVal.toLowerCase()){
      matchedId = id; matchedName = name;
    }
  });

  if(!matchedId){ alert("未找到匹配产品"); return; }

  let finalQty = qtyVal;
  try { finalQty = eval(qtyVal.replace(/[^-()\d/*+.]/g,"")); } catch {}

  records.push({id: matchedId, name: matchedName, qty: finalQty});
  localStorage.setItem("records", JSON.stringify(records));
  document.getElementById("quantityInput").value = "";
  renderTable();
};

// 导出 CSV
document.getElementById("exportCSV").onclick = () => {
  const rows = [["产品代号","产品名称","数量"]];
  records.forEach(r => { rows.push([r.id,r.name,r.qty]); });
  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download","inventory.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

// 清空所有
document.getElementById("clearAll").onclick = () => {
  if(confirm("确认清空所有数据吗？")){
    records = [];
    localStorage.removeItem("records");
    renderTable();
  }
};

renderTable();
</script>

</body>
</html>
