<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>库存记录小程序</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; font-size: 1.5em; }
input, textarea { padding: 12px; margin: 5px 0; font-size: 1.5em; width: 70%; height: 50px; }
button { padding: 12px; margin: 5px; font-size: 1.5em; }
#addRecord { background: orange; color: white; border: none; width: 120px; height: 160px; font-size: 1.5em; vertical-align: top; }
#controls button { font-size: 0.75em; padding: 8px; margin: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 12px; }
th, td { border: 1px solid #ccc; padding: 6px; }
th { background: #eee; }
#suggestions { border: 1px solid #ccc; max-height: 200px; overflow-y: auto; background: #fff; position: absolute; z-index: 1000; font-size: 1.2em; }
#suggestions div { padding: 6px; cursor: pointer; }
#suggestions div:hover { background: #eee; }
.input-wrapper { position: relative; display: inline-block; width: 70%; }
#selectedName { 
    width: 100%;           /* 框变长，占页面一半宽度 */
    height: 50px; 
    font-size: 1em;       /* 字体稍小 */
    padding: 12px; 
    margin-left: 10px; 
    white-space: nowrap;  /* 单行显示 */
    overflow: hidden;     /* 超出部分隐藏 */
    text-overflow: ellipsis; /* 超出显示省略号 */
}
.smallInput { width:100%; height:25px; font-size:0.75em; }
.smallButton { font-size:0.75em; padding:4px 6px; }
</style>
</head>
<body>
<div style="display:flex; align-items:flex-start;">
  <div style="flex:1;">
    <div class="input-wrapper">
      <input type="text" id="search" placeholder="搜索产品代号或名称...">
      <div id="suggestions"></div>
    </div>
    <input type="text" id="selectedName" placeholder="选中产品名称" readonly>
    <div>
      <input type="text" id="quantityInput" placeholder="数量（可用 12*5 等公式）">
    </div>
    <div>
      <input type="text" id="noteInput" placeholder="备注（可填过期日期等）">
    </div>
  </div>
  <div>
    <button id="addRecord">添加记录</button>
  </div>
</div>

<div id="controls">
  <button id="exportCSV">导出 CSV</button>
  <button id="clearAll" style="background:#e74c3c;color:white;">清空所有</button>
</div>

<table>
<thead>
<tr>
<th>产品代号</th>
<th>产品名称</th>
<th>数量</th>
<th>备注</th>
<th>操作</th>
</tr>
</thead>
<tbody id="recordTable"></tbody>
</table>

<script>
let products = {};
let records = JSON.parse(localStorage.getItem("records") || "[]");

// 加载外部JSON
fetch("products.json")
  .then(res => res.json())
  .then(data => { products = data; renderTable(); })
  .catch(err => alert("加载产品列表失败：" + err));

const searchInput = document.getElementById("search");
const suggestionsDiv = document.getElementById("suggestions");
const selectedNameInput = document.getElementById("selectedName");

// 模糊搜索
searchInput.addEventListener("input", () => {
  const val = searchInput.value.toLowerCase();
  suggestionsDiv.innerHTML = "";
  if(val==="") { selectedNameInput.value=""; return; }
  const matches = Object.entries(products).filter(([id,name]) => id.toLowerCase().includes(val) || name.toLowerCase().includes(val)).slice(0,10);
  matches.forEach(([id,name]) => {
    const div = document.createElement("div"); div.textContent = `${id} - ${name}`;
    div.onclick = () => { 
      searchInput.value = id; 
      selectedNameInput.value = name;
      suggestionsDiv.innerHTML = ""; 
    };
    suggestionsDiv.appendChild(div);
  });
});

// 渲染表格
function renderTable() {
  const tbody = document.getElementById("recordTable");
  tbody.innerHTML = "";
  for(let i = records.length - 1; i >= 0; i--) {
    const record = records[i];
    const tr = document.createElement("tr");

    const tdId = document.createElement("td"); tdId.textContent = record.id; tr.appendChild(tdId);
    const tdName = document.createElement("td"); tdName.textContent = record.name; tr.appendChild(tdName);

    const tdQty = document.createElement("td");
    const inputQty = document.createElement("input"); 
    inputQty.type="text"; inputQty.value=record.qty; 
    inputQty.className="smallInput";
    inputQty.onchange = () => {
      let val = inputQty.value;
      try { if(val.trim()!=="") val = eval(val.replace(/[^-()\d/*+.]/g,"")); } catch {}
      records[i].qty = val;
      localStorage.setItem("records", JSON.stringify(records));
      renderTable();
    };
    tdQty.appendChild(inputQty); tr.appendChild(tdQty);

    const tdNote = document.createElement("td");
    const inputNote = document.createElement("input"); 
    inputNote.type="text"; inputNote.value=record.note||""; 
    inputNote.className="smallInput";
    inputNote.onchange = () => { records[i].note = inputNote.value; localStorage.setItem("records", JSON.stringify(records)); };
    tdNote.appendChild(inputNote); tr.appendChild(tdNote);

    const tdAction = document.createElement("td");
    const delBtn = document.createElement("button"); delBtn.textContent = "删除";
    delBtn.className="smallButton";
    delBtn.onclick = () => { records.splice(i,1); localStorage.setItem("records", JSON.stringify(records)); renderTable(); };
    tdAction.appendChild(delBtn); tr.appendChild(tdAction);

    tbody.appendChild(tr);
  }
}

// 添加记录
document.getElementById("addRecord").onclick = () => {
  const searchVal = searchInput.value.trim();
  const qtyVal = document.getElementById("quantityInput").value.trim();
  const noteVal = document.getElementById("noteInput").value.trim();
  if(!searchVal || !qtyVal){ alert("请填写产品和数量"); return; }

  let matchedId=null, matchedName=null;
  Object.entries(products).forEach(([id,name])=>{
    if(id.toLowerCase()===searchVal.toLowerCase() || name.toLowerCase()===searchVal.toLowerCase()){ matchedId=id; matchedName=name; }
  });
  if(!matchedId){ alert("未找到匹配产品"); return; }

  let finalQty = qtyVal;
  try { finalQty = eval(qtyVal.replace(/[^-()\d/*+.]/g,"")); } catch {}

  records.push({id:matchedId,name:matchedName,qty:finalQty,note:noteVal});
  localStorage.setItem("records", JSON.stringify(records));

  searchInput.value=""; selectedNameInput.value=""; document.getElementById("quantityInput").value=""; document.getElementById("noteInput").value="";
  renderTable();
};

// 导出 CSV
document.getElementById("exportCSV").onclick = () => {
  const rows = [["code","qty","note"]];
  records.forEach(r=>rows.push([r.id,r.qty,r.note||""]));
  const csvContent = "data:text/csv;charset=utf-8,"+rows.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download","inventory.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
};

// 清空所有
document.getElementById("clearAll").onclick = () => {
  if(confirm("确认清空所有数据吗？")){ records=[]; localStorage.removeItem("records"); renderTable(); }
};

renderTable();
</script>

</body>
</html>


